{% extends "base.html" %}
{% block title %}Maintenance DB{% endblock %}
{% block page_title %}Maintenance Base de Données{% endblock %}

{% block content %}
<!-- Statistiques -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card shadow-sm bg-primary text-white">
            <div class="card-body">
                <h6 class="card-title"><i class="bi bi-database"></i> Entrées CMDB</h6>
                <h3 class="mb-0">{{ "{:,}".format(stats.cmdb_count).replace(',', ' ') }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card shadow-sm bg-success text-white">
            <div class="card-body">
                <h6 class="card-title"><i class="bi bi-activity"></i> Jobs Total</h6>
                <h3 class="mb-0">{{ "{:,}".format(stats.jobs_count).replace(',', ' ') }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card shadow-sm bg-warning text-dark">
            <div class="card-body">
                <h6 class="card-title"><i class="bi bi-clock-history"></i> Jobs > 6 mois</h6>
                <h3 class="mb-0">{{ "{:,}".format(stats.jobs_old_count).replace(',', ' ') }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card shadow-sm {% if stats.dedup_active %}bg-info{% else %}bg-secondary{% endif %} text-white">
            <div class="card-body">
                <h6 class="card-title"><i class="bi bi-layers"></i> Déduplication</h6>
                <h3 class="mb-0">{% if stats.dedup_active %}Activée{% else %}Désactivée{% endif %}</h3>
            </div>
        </div>
    </div>
</div>

<!-- Actions de nettoyage -->
<div class="row">
    <!-- Nettoyage jobs > 6 mois -->
    <div class="col-lg-6 mb-4">
        <div class="card shadow-sm border-warning">
            <div class="card-header bg-warning">
                <h5 class="mb-0">
                    <i class="bi bi-broom"></i> Nettoyer jobs > 6 mois
                </h5>
            </div>
            <div class="card-body">
                <p class="text-muted">
                    Supprime tous les jobs dont la date de backup remonte à plus de 6 mois.
                    Cette opération est <strong>réversible uniquement par restauration</strong>.
                </p>
                <div class="alert alert-info">
                    <strong>{{ "{:,}".format(stats.jobs_old_count).replace(',', ' ') }} jobs</strong> seront supprimés
                </div>
                <form action="{{ url_for('admin.nettoyer') }}" method="POST" 
                      onsubmit="return confirm('Voulez-vous vraiment supprimer {{ stats.jobs_old_count }} jobs de plus de 6 mois ?');">
                    <button type="submit" class="btn btn-warning w-100">
                        <i class="bi bi-trash"></i> Nettoyer maintenant
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Supprimer doublons -->
    <div class="col-lg-6 mb-4">
        <div class="card shadow-sm border-info">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                    <i class="bi bi-layers"></i> Supprimer les doublons
                </h5>
            </div>
            <div class="card-body">
                <p class="text-muted">
                    Détecte et supprime les jobs en double (même Job ID + même date de backup).
                    Conserve uniquement l'entrée la plus récente.
                </p>

                <form action="{{ url_for('admin.config_dedup') }}" method="POST" class="mb-3">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" name="actif" 
                               id="dedupSwitch" {% if stats.dedup_active %}checked{% endif %}>
                        <label class="form-check-label fw-bold" for="dedupSwitch">
                            Déduplication automatique
                        </label>
                    </div>
                    <button type="submit" class="btn btn-sm btn-outline-info mt-2">
                        <i class="bi bi-save"></i> Enregistrer
                    </button>
                </form>

                <form action="{{ url_for('admin.supprimer_doublons') }}" method="POST"
                      onsubmit="return confirm('Lancer la déduplication manuelle ?');">
                    <button type="submit" class="btn btn-info text-white w-100">
                        <i class="bi bi-play-circle"></i> Lancer maintenant
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- DANGER ZONE -->
<div class="card shadow-sm border-danger mb-4">
    <div class="card-header bg-danger text-white">
        <h5 class="mb-0">
            <i class="bi bi-exclamation-triangle-fill"></i> DANGER ZONE - Purges complètes
        </h5>
    </div>
    <div class="card-body">
        <div class="alert alert-danger">
            <strong><i class="bi bi-shield-exclamation"></i> ATTENTION :</strong>
            Ces actions sont <strong>IRRÉVERSIBLES</strong> et suppriment <strong>TOUTES</strong> les données.
            Assurez-vous d'avoir une sauvegarde récente avant de continuer.
        </div>

        <div class="row">
            <!-- Purge CMDB -->
            <div class="col-md-6 mb-3">
                <div class="card border-danger">
                    <div class="card-header bg-light">
                        <h6 class="mb-0 text-danger">
                            <i class="bi bi-database-x"></i> Vidage CMDB
                        </h6>
                    </div>
                    <div class="card-body">
                        <p class="small text-muted">
                            Supprime <strong>{{ "{:,}".format(stats.cmdb_count).replace(',', ' ') }} entrées CMDB</strong>.
                        </p>
                        <form action="{{ url_for('admin.purge_cmdb') }}" method="POST">
                            <div class="mb-2">
                                <label class="form-label small">Tapez <code>DELETE</code> pour confirmer :</label>
                                <input type="text" class="form-control" name="confirmation" 
                                       placeholder="DELETE" required>
                            </div>
                            <button type="submit" class="btn btn-danger w-100">
                                <i class="bi bi-trash3"></i> Purger la CMDB
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Purge Jobs -->
            <div class="col-md-6 mb-3">
                <div class="card border-danger">
                    <div class="card-header bg-light">
                        <h6 class="mb-0 text-danger">
                            <i class="bi bi-activity"></i> Vidage Jobs
                        </h6>
                    </div>
                    <div class="card-body">
                        <p class="small text-muted">
                            Supprime <strong>{{ "{:,}".format(stats.jobs_count).replace(',', ' ') }} jobs Altaview</strong>.
                        </p>
                        <form action="{{ url_for('admin.purge_altaview') }}" method="POST">
                            <div class="mb-2">
                                <label class="form-label small">Tapez <code>DELETE</code> pour confirmer :</label>
                                <input type="text" class="form-control" name="confirmation" 
                                       placeholder="DELETE" required>
                            </div>
                            <button type="submit" class="btn btn-danger w-100">
                                <i class="bi bi-trash3"></i> Purger les Jobs
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Informations -->
<div class="card shadow-sm border-primary">
    <div class="card-header bg-primary text-white">
        <h6 class="mb-0">
            <i class="bi bi-info-circle"></i> Informations
        </h6>
    </div>
    <div class="card-body">
        <ul class="mb-0">
            <li><strong>Sauvegardes</strong> : Avant toute purge, créez une sauvegarde dans 
                <a href="{{ url_for('backup.index') }}">Sauvegarde & Restauration</a>
            </li>
            <li><strong>Logs</strong> : Toutes les opérations de maintenance sont tracées dans l'historique</li>
            <li><strong>Performance</strong> : Le nettoyage régulier des vieux jobs améliore les performances</li>
            <li><strong>Déduplication</strong> : Activez la déduplication automatique pour éviter les doublons lors des imports</li>
        </ul>
    </div>
</div>
{% endblock %}
