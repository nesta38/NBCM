{% extends "base.html" %}
{% block title %}{{ t('nav_cmdb') }}{% endblock %}
{% block page_title %}{{ t('cmdb_title') }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <a href="{{ url_for('cmdb.import_page') }}" class="btn btn-primary"><i class="bi bi-upload"></i> {{ t('btn_import') }}</a>
        <a href="{{ url_for('cmdb.export') }}" class="btn btn-success"><i class="bi bi-download"></i> {{ t('btn_export') }}</a>
    </div>
</div>

<div class="card shadow-sm mb-4">
    <div class="card-header" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
        <h6 class="mb-0 text-white fw-bold"><i class="bi bi-funnel-fill"></i> {{ t('btn_filter') }}</h6>
    </div>
    <div class="card-body">
        <form method="GET" class="row g-3 align-items-end">
            <div class="col-md-4">
                <label class="form-label fw-bold"><i class="bi bi-funnel"></i> {{ t('lbl_backup_state') }}</label>
                <select name="filtre_backup" class="form-select" onchange="this.form.submit()">
                    <option value="tous" {% if filtre_backup == 'tous' %}selected{% endif %}>üìä {{ t('cmdb_filter_all') }}</option>
                    <option value="actif" {% if filtre_backup == 'actif' %}selected{% endif %}>‚úÖ {{ t('cmdb_filter_active') }}</option>
                    <option value="inactif" {% if filtre_backup == 'inactif' %}selected{% endif %}>‚ùå {{ t('cmdb_filter_inactive') }}</option>
                </select>
            </div>
            <div class="col-md-6">
                <label class="form-label fw-bold"><i class="bi bi-search"></i> {{ t('btn_search') }}</label>
                <input type="text" name="search" class="form-control" placeholder="{{ t('cmdb_search_placeholder') }}" value="{{ search }}">
            </div>
            <div class="col-md-2"><button type="submit" class="btn btn-primary w-100"><i class="bi bi-filter"></i> {{ t('btn_filter') }}</button></div>
        </form>
        <div class="mt-2 text-muted small"><i class="bi bi-info-circle"></i> {{ serveurs|length }} {{ t('cmdb_servers_displayed') }}</div>
    </div>
</div>

<div class="card shadow-sm">
    <div class="card-body">
        <table class="table table-hover datatable">
            <thead>
                <tr>
                    <th>{{ t('th_hostname') }}</th>
                    <th>{{ t('th_backup_active') }}</th>
                    <th>{{ t('th_temp_deactivation') }}</th>
                    <th>{{ t('th_comment') }}</th>
                    <th>{{ t('th_actions') }}</th>
                </tr>
            </thead>
            <tbody>
                {% for s in serveurs %}
                <tr>
                    <td><strong>{{ s.hostname }}</strong></td>
                    <td>
                        <form method="POST" action="{{ url_for('cmdb.toggle', id=s.id, filtre_backup=filtre_backup, search=search) }}" class="d-inline">
                            <button type="submit" class="btn btn-sm {{ 'btn-success' if s.backup_enabled else 'btn-secondary' }}">
                                <i class="bi {{ 'bi-check-circle' if s.backup_enabled else 'bi-x-circle' }}"></i>
                                {{ t('cmdb_yes') if s.backup_enabled else t('cmdb_no') }}
                            </button>
                        </form>
                    </td>
                    <td>
                        {% if s.est_desactive_temporairement() %}
                            <span class="badge bg-warning text-dark"><i class="bi bi-pause-circle"></i> {{ t('until') }} {{ s.date_fin_desactivation.strftime('%d/%m') }}</span>
                            <form method="POST" action="{{ url_for('cmdb.reactiver', id=s.id) }}" class="d-inline ms-2"><button type="submit" class="btn btn-sm btn-outline-success" title="{{ t('cmdb_reactivate') }}"><i class="bi bi-play-fill"></i></button></form>
                        {% else %}
                            <button class="btn btn-sm btn-outline-warning" data-bs-toggle="modal" data-bs-target="#modalPause" onclick="document.getElementById('pauseServerId').value='{{ s.id }}';document.getElementById('pauseHostname').textContent='{{ s.hostname }}'">
                                <i class="bi bi-pause-fill"></i> {{ t('cmdb_pause') }}
                            </button>
                        {% endif %}
                    </td>
                    <td><span class="text-muted small">{{ (s.commentaire or '')[:40] }}{% if s.commentaire and s.commentaire|length > 40 %}...{% endif %}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-info" data-bs-toggle="modal" data-bs-target="#modalComment" onclick="document.getElementById('commentServerId').value='{{ s.id }}';document.getElementById('commentHostname').textContent='{{ s.hostname }}';document.getElementById('commentText').value='{{ s.commentaire or '' }}'">
                            <i class="bi bi-chat-left-text"></i>
                        </button>
                    </td>
                </tr>
                {% else %}
                <tr><td colspan="5" class="text-center py-5 text-muted">{{ t('lbl_no_data') }}</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="modal fade" id="modalPause" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('cmdb.desactiver', id=0) }}" id="formPause">
                <input type="hidden" name="server_id" id="pauseServerId">
                <div class="modal-header bg-warning"><h5 class="modal-title"><i class="bi bi-pause-circle"></i> {{ t('cmdb_deactivate_title') }} <span id="pauseHostname"></span></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <div class="alert alert-info"><i class="bi bi-info-circle"></i> {{ t('cmdb_deactivate_info') }}</div>
                    <div class="mb-3"><label class="form-label fw-bold">{{ t('cmdb_duration_days') }}</label><input type="number" name="duree_jours" class="form-control" value="30" min="1" max="365" required></div>
                    <div class="mb-3"><label class="form-label fw-bold">{{ t('cmdb_reason') }}</label><input type="text" name="raison" class="form-control" placeholder="{{ t('cmdb_reason_placeholder') }}" required></div>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ t('btn_cancel') }}</button><button type="submit" class="btn btn-warning">{{ t('btn_confirm') }}</button></div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="modalComment" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('cmdb.update_commentaire', id=0) }}" id="formComment">
                <input type="hidden" name="server_id" id="commentServerId">
                <div class="modal-header bg-info text-white"><h5 class="modal-title"><i class="bi bi-chat-left-text"></i> {{ t('th_comment') }} - <span id="commentHostname"></span></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <div class="mb-3"><label class="form-label fw-bold">{{ t('lbl_notes') }}</label><textarea name="commentaire" id="commentText" class="form-control" rows="4"></textarea></div>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ t('btn_close') }}</button><button type="submit" class="btn btn-primary">{{ t('btn_save') }}</button></div>
            </form>
        </div>
    </div>
</div>
{% endblock %}
{% block extra_js %}
<script>
document.getElementById('formPause').addEventListener('submit', function(e) { e.preventDefault(); this.action = '/cmdb/desactiver/' + document.getElementById('pauseServerId').value; this.submit(); });
document.getElementById('formComment').addEventListener('submit', function(e) { e.preventDefault(); this.action = '/cmdb/commentaire/' + document.getElementById('commentServerId').value; this.submit(); });
</script>
{% endblock %}
