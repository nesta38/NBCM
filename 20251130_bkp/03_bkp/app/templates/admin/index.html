{% extends "base.html" %}
{% block title %}{{ t('nav_admin') }}{% endblock %}
{% block page_title %}{{ t('admin_title') }}{% endblock %}

{% block content %}
<div class="card shadow-sm mb-4 border-primary">
    <div class="card-header bg-primary text-white d-flex justify-content-between">
        <h5 class="mb-0"><i class="bi bi-heart-pulse"></i> {{ t('admin_system_status') }}</h5>
        <span class="badge bg-white text-primary">Uptime: {{ system_health.uptime }}</span>
    </div>
    <div class="card-body">
        <div class="row text-center">
            <div class="col-md-4">
                <h6 class="text-muted">Scheduler</h6>
                {% if system_health.scheduler %}
                    <h4 class="text-success"><i class="bi bi-check-circle-fill"></i> {{ t('status_active') }}</h4>
                    <ul class="list-unstyled small">{% for job in system_health.jobs %}<li><i class="bi bi-clock"></i> {{ job.id }}: <strong>{{ job.next_run }}</strong></li>{% endfor %}</ul>
                {% else %}<h4 class="text-danger"><i class="bi bi-x-circle-fill"></i> {{ t('status_inactive') }}</h4>{% endif %}
            </div>
            <div class="col-md-4 border-start border-end">
                <h6 class="text-muted">{{ t('admin_database') }}</h6>
                {% if system_health.db == "OK" %}<h4 class="text-success"><i class="bi bi-database-check"></i> {{ t('status_connected') }}</h4>{% else %}<h4 class="text-danger"><i class="bi bi-database-x"></i> {{ t('status_error') }}</h4>{% endif %}
            </div>
            <div class="col-md-4">
                <h6 class="text-muted">{{ t('admin_last_import') }}</h6>
                {% if system_health.last_imap %}<h4 class="text-success">{{ system_health.last_imap.date_import.strftime('%H:%M') }}</h4><small>{{ system_health.last_imap.message[:30] }}...</small>{% else %}<h4 class="text-muted">-</h4>{% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-xl-6 mb-4">
        <div class="card shadow-sm h-100 border-secondary">
            <div class="card-header bg-secondary text-white"><h5 class="mb-0"><i class="bi bi-envelope-at"></i> {{ t('admin_email_config') }}</h5></div>
            <div class="card-body">
                <h6 class="text-primary mb-3"><i class="bi bi-send"></i> {{ t('admin_smtp_title') }}</h6>
                {% set email_config = get_config('email_rapport', {}) %}
                <form action="{{ url_for('admin.config_email') }}" method="POST">
                    <div class="row g-2">
                        <div class="col-md-8"><label class="form-label small">SMTP Server</label><input type="text" class="form-control form-control-sm" name="smtp_server" value="{{ email_config.get('smtp_server', '') }}"></div>
                        <div class="col-md-4"><label class="form-label small">Port</label><input type="text" class="form-control form-control-sm" name="smtp_port" value="{{ email_config.get('smtp_port', '587') }}"></div>
                        <div class="col-md-6"><label class="form-label small">User</label><input type="text" class="form-control form-control-sm" name="smtp_user" value="{{ email_config.get('smtp_user', '') }}"></div>
                        <div class="col-md-6"><label class="form-label small">Password</label><input type="password" class="form-control form-control-sm" name="smtp_password" value="{{ email_config.get('smtp_password', '') }}"></div>
                        <div class="col-md-6"><label class="form-label small">From</label><input type="text" class="form-control form-control-sm" name="email_from" value="{{ email_config.get('email_from', '') }}"></div>
                        <div class="col-md-6"><label class="form-label small">To</label><input type="text" class="form-control form-control-sm" name="email_to" value="{{ email_config.get('email_to', '') }}"></div>
                    </div>
                    <div class="mt-3 d-flex justify-content-between align-items-center">
                        <div class="form-check form-switch"><input class="form-check-input" type="checkbox" name="actif" id="smtpSwitch" {% if email_config.get('actif') %}checked{% endif %}><label class="form-check-label small" for="smtpSwitch">{{ t('admin_enable_auto_send') }}</label></div>
                        <div><button type="submit" formaction="{{ url_for('admin.test_email') }}" class="btn btn-outline-secondary btn-sm"><i class="bi bi-send-check"></i> {{ t('btn_test') }}</button> <button type="submit" class="btn btn-primary btn-sm"><i class="bi bi-save"></i> {{ t('btn_save') }}</button></div>
                    </div>
                </form>
                <hr class="my-4">
                <h6 class="text-info mb-3"><i class="bi bi-inbox"></i> {{ t('admin_imap_title') }}</h6>
                {% set imap_config = get_config('email_import', {}) %}
                <form action="{{ url_for('admin.config_imap') }}" method="POST">
                    <div class="row g-2">
                        <div class="col-md-8"><label class="form-label small">IMAP Server</label><input type="text" class="form-control form-control-sm" name="server" value="{{ imap_config.get('server', '') }}"></div>
                        <div class="col-md-4"><label class="form-label small">Interval</label><input type="number" class="form-control form-control-sm" name="check_interval" value="{{ imap_config.get('check_interval', 15) }}"></div>
                        <div class="col-md-6"><label class="form-label small">User</label><input type="text" class="form-control form-control-sm" name="user" value="{{ imap_config.get('user', '') }}"></div>
                        <div class="col-md-6"><label class="form-label small">Password</label><input type="password" class="form-control form-control-sm" name="password" value="{{ imap_config.get('password', '') }}"></div>
                        <div class="col-md-6"><label class="form-label small">Subject Filter</label><input type="text" class="form-control form-control-sm" name="subject_filter" value="{{ imap_config.get('subject_filter', 'NetBackup') }}"></div>
                        <div class="col-md-6"><label class="form-label small">Archive Folder</label><input type="text" class="form-control form-control-sm" name="archive_folder" value="{{ imap_config.get('archive_folder', 'Archives_Altaview') }}"></div>
                    </div>
                    <div class="mt-3 d-flex justify-content-between align-items-center">
                        <div class="form-check form-switch"><input class="form-check-input" type="checkbox" name="actif" id="imapSwitch" {% if imap_config.get('actif') %}checked{% endif %}><label class="form-check-label small" for="imapSwitch">{{ t('admin_enable_auto_import') }}</label></div>
                        <div><button type="submit" formaction="{{ url_for('admin.test_imap') }}" class="btn btn-outline-info btn-sm"><i class="bi bi-envelope-open"></i> {{ t('btn_test') }}</button> <button type="submit" class="btn btn-info btn-sm"><i class="bi bi-save"></i> {{ t('btn_save') }}</button></div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-xl-6 mb-4">
        <div class="card shadow-sm h-100 border-success">
            <div class="card-header bg-success text-white"><h5 class="mb-0"><i class="bi bi-cloud-arrow-down"></i> API Altaview</h5></div>
            <div class="card-body">
                {% set api_config = get_config('altaview_api', {}) %}
                <form action="{{ url_for('admin.config_api') }}" method="POST">
                    <p class="text-muted small">{{ t('admin_api_config') }}</p>
                    <div class="mb-3"><label class="form-label fw-bold">{{ t('admin_api_url') }}</label><input type="text" class="form-control" name="url" value="{{ api_config.get('url', '') }}"></div>
                    <div class="mb-3"><label class="form-label fw-bold">{{ t('admin_api_token') }}</label><input type="password" class="form-control" name="token" value="{{ api_config.get('token', '') }}"></div>
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="form-check form-switch"><input class="form-check-input" type="checkbox" name="actif" id="apiSwitch" {% if api_config.get('actif') %}checked{% endif %}><label class="form-check-label fw-bold" for="apiSwitch">{% if api_config.get('actif') %}<span class="badge bg-success">{{ t('status_active') }}</span>{% else %}<span class="badge bg-secondary">{{ t('status_inactive') }}</span>{% endif %}</label></div>
                        <div><button type="submit" formaction="{{ url_for('admin.test_api') }}" class="btn btn-outline-success btn-sm">{{ t('btn_test') }}</button> <button type="submit" class="btn btn-success">{{ t('btn_save') }}</button></div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="card shadow-sm mb-4 border-info">
    <div class="card-header bg-info text-white"><h5 class="mb-0"><i class="bi bi-calendar-check"></i> {{ t('admin_archive_config') }}</h5></div>
    <div class="card-body">
        {% set arch_config = get_config('archive_config', {'heure': 18, 'minute': 0, 'actif': True}) %}
        <form action="{{ url_for('admin.config_archive') }}" method="POST">
            <div class="row align-items-end">
                <div class="col-md-6"><label class="form-label fw-bold">{{ t('admin_archive_time') }}</label><div class="input-group"><span class="input-group-text"><i class="bi bi-clock"></i></span><input type="number" name="heure" class="form-control" value="{{ arch_config.get('heure', 18) }}" min="0" max="23"><span class="input-group-text">:</span><input type="number" name="minute" class="form-control" value="{{ arch_config.get('minute', 0) }}" min="0" max="59"></div></div>
                <div class="col-md-6"><div class="form-check form-switch mb-2"><input class="form-check-input" type="checkbox" name="actif" id="archActive" {% if arch_config.get('actif', True) %}checked{% endif %}><label class="form-check-label" for="archActive">{{ t('admin_archive_auto') }}</label></div><button type="submit" class="btn btn-info text-white btn-sm w-100"><i class="bi bi-save"></i> {{ t('btn_save') }}</button></div>
            </div>
        </form>
        <hr>
        <div class="d-flex justify-content-between align-items-center">
            <div><strong class="text-primary">{{ t('admin_archive_manual') }}</strong><p class="small text-muted mb-0">{{ t('admin_archive_manual_desc') }}</p></div>
            <form action="{{ url_for('admin.test_archive') }}" method="POST"><button type="submit" class="btn btn-outline-primary btn-sm"><i class="bi bi-camera-fill"></i> {{ t('admin_create_snapshot') }}</button></form>
        </div>
    </div>
</div>

<!-- NOUVEAU : Carte Backup & Restore -->
<div class="card shadow-sm mb-4 border-primary">
    <div class="card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
        <h5 class="text-white fw-bold mb-0">
            <i class="bi bi-database-fill-gear"></i> 
            {{ t('admin_backup_restore') }}
        </h5>
    </div>
    <div class="card-body">
        <p class="text-muted">
            {{ t('admin_backup_desc') }}
        </p>
        <a href="{{ url_for('backup.index') }}" class="btn btn-primary w-100">
            <i class="bi bi-gear-fill"></i> Gérer les Sauvegardes
        </a>
    </div>
</div>

<!-- Nettoyage automatique fichiers -->
<div class="card shadow-sm mb-4 border-warning">
    <div class="card-header bg-warning text-dark">
        <h5 class="mb-0"><i class="bi bi-files"></i> Nettoyage Fichiers Auto-Import</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-8">
                <h6 class="text-warning mb-2"><i class="bi bi-info-circle"></i> Purge automatique</h6>
                <p class="small text-muted mb-3">
                    Les fichiers importés depuis <code>/app/data/altaview_auto_import/processed/</code> 
                    sont automatiquement supprimés après <strong>48 heures</strong>.
                    <br>Planification : <strong>Tous les jours à 3h00</strong>
                </p>
                <div id="cleanup-stats" class="p-3 bg-light rounded">
                    <div class="d-flex justify-content-center">
                        <div class="spinner-border spinner-border-sm text-warning" role="status">
                            <span class="visually-hidden">Chargement...</span>
                        </div>
                        <span class="ms-2 small">Chargement des statistiques...</span>
                    </div>
                </div>
            </div>
            <div class="col-md-4 border-start">
                <h6 class="text-warning mb-2"><i class="bi bi-play-circle"></i> Action manuelle</h6>
                <p class="small text-muted">Déclencher le nettoyage immédiatement</p>
                <form action="{{ url_for('admin.cleanup_now') }}" method="POST">
                    <button type="submit" class="btn btn-warning w-100">
                        <i class="bi bi-trash"></i> Nettoyer maintenant
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="card shadow-sm border-danger">
    <div class="card-header bg-danger text-white"><h5 class="mb-0"><i class="bi bi-database-gear"></i> {{ t('admin_maintenance') }}</h5></div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-4 mb-3"><h6 class="text-primary mb-3"><i class="bi bi-broom"></i> {{ t('admin_auto_clean') }}</h6><form action="{{ url_for('admin.nettoyer') }}" method="POST" class="mb-3"><button type="submit" class="btn btn-outline-danger btn-sm w-100">{{ t('admin_clean_jobs') }}</button></form><form action="{{ url_for('admin.supprimer_doublons') }}" method="POST"><button type="submit" class="btn btn-outline-warning btn-sm w-100">{{ t('admin_remove_duplicates') }}</button></form></div>
            <div class="col-md-4 mb-3 border-start"><h6 class="text-danger mb-3"><i class="bi bi-exclamation-triangle-fill"></i> {{ t('admin_danger_cmdb') }}</h6><button type="button" class="btn btn-danger btn-sm w-100" data-bs-toggle="modal" data-bs-target="#modalPurgeCMDB">{{ t('admin_purge_cmdb_desc') }}</button></div>
            <div class="col-md-4 mb-3 border-start"><h6 class="text-danger mb-3"><i class="bi bi-exclamation-triangle-fill"></i> {{ t('admin_danger_jobs') }}</h6><button type="button" class="btn btn-danger btn-sm w-100" data-bs-toggle="modal" data-bs-target="#modalPurgeJobs">{{ t('admin_purge_jobs_desc') }}</button></div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalPurgeCMDB" tabindex="-1"><div class="modal-dialog"><div class="modal-content border-danger"><div class="modal-header bg-danger text-white"><h5 class="modal-title"><i class="bi bi-exclamation-triangle-fill"></i> ATTENTION</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><form action="{{ url_for('admin.purge_cmdb') }}" method="POST"><div class="modal-body"><div class="alert alert-danger"><strong>⚠️ {{ t('admin_irreversible') }}</strong></div><div class="mb-3 text-center"><code class="fs-5 text-danger fw-bold bg-light px-3 py-2 rounded">DELETE</code></div><input type="text" name="confirmation" class="form-control form-control-lg text-center" placeholder="{{ t('admin_type_delete') }}" required pattern="DELETE"></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ t('btn_cancel') }}</button><button type="submit" class="btn btn-danger">{{ t('admin_confirm_purge') }}</button></div></form></div></div></div>
<div class="modal fade" id="modalPurgeJobs" tabindex="-1"><div class="modal-dialog"><div class="modal-content border-danger"><div class="modal-header bg-danger text-white"><h5 class="modal-title"><i class="bi bi-exclamation-triangle-fill"></i> ATTENTION</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><form action="{{ url_for('admin.purge_altaview') }}" method="POST"><div class="modal-body"><div class="alert alert-danger"><strong>⚠️ {{ t('admin_irreversible') }}</strong></div><div class="mb-3 text-center"><code class="fs-5 text-danger fw-bold bg-light px-3 py-2 rounded">DELETE</code></div><input type="text" name="confirmation" class="form-control form-control-lg text-center" placeholder="{{ t('admin_type_delete') }}" required pattern="DELETE"></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ t('btn_cancel') }}</button><button type="submit" class="btn btn-danger">{{ t('admin_confirm_purge') }}</button></div></form></div></div></div>

<script>
// Charger les statistiques de nettoyage
document.addEventListener('DOMContentLoaded', function() {
    loadCleanupStats();
});

function loadCleanupStats() {
    fetch('{{ url_for("admin.cleanup_stats") }}')
        .then(response => response.json())
        .then(data => {
            const statsDiv = document.getElementById('cleanup-stats');
            
            if (!data.exists) {
                statsDiv.innerHTML = `
                    <div class="alert alert-warning mb-0">
                        <i class="bi bi-exclamation-triangle"></i>
                        Répertoire processed/ introuvable
                    </div>
                `;
                return;
            }
            
            const eligiblePercent = data.total_files > 0 
                ? ((data.eligible_for_deletion / data.total_files) * 100).toFixed(1)
                : 0;
            
            statsDiv.innerHTML = `
                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="text-center">
                            <div class="fs-4 fw-bold text-primary">${data.total_files}</div>
                            <div class="small text-muted">Fichiers totaux</div>
                            <div class="small text-muted">${data.total_size_mb} MB</div>
                        </div>
                    </div>
                    <div class="col-md-4 border-start border-end">
                        <div class="text-center">
                            <div class="fs-4 fw-bold ${data.eligible_for_deletion > 0 ? 'text-warning' : 'text-success'}">
                                ${data.eligible_for_deletion}
                            </div>
                            <div class="small text-muted">Éligibles suppression</div>
                            <div class="small text-muted">${data.eligible_size_mb} MB</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center">
                            <div class="fs-4 fw-bold text-info">${eligiblePercent}%</div>
                            <div class="small text-muted">Pourcentage</div>
                            <div class="small text-muted">Fichiers > 48h</div>
                        </div>
                    </div>
                </div>
                ${data.eligible_for_deletion > 0 ? `
                    <div class="alert alert-warning mt-3 mb-0">
                        <i class="bi bi-info-circle"></i>
                        <strong>${data.eligible_for_deletion} fichiers</strong> peuvent être supprimés 
                        pour libérer <strong>${data.eligible_size_mb} MB</strong>
                    </div>
                ` : `
                    <div class="alert alert-success mt-3 mb-0">
                        <i class="bi bi-check-circle"></i>
                        Aucun fichier à nettoyer pour le moment
                    </div>
                `}
            `;
        })
        .catch(error => {
            const statsDiv = document.getElementById('cleanup-stats');
            statsDiv.innerHTML = `
                <div class="alert alert-danger mb-0">
                    <i class="bi bi-x-circle"></i>
                    Erreur de chargement des statistiques
                </div>
            `;
            console.error('Erreur:', error);
        });
}
</script>
{% endblock %}
