{% extends "base.html" %}
{% block title %}Maintenance DB{% endblock %}
{% block page_title %}Maintenance Base de Données - Vue d'ensemble{% endblock %}

{% block content %}
<!-- Statistiques -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card shadow-sm bg-primary text-white">
            <div class="card-body">
                <h6 class="card-title"><i class="bi bi-database"></i> Entrées CMDB</h6>
                <h3 class="mb-0">{{ "{:,}".format(stats.cmdb_count).replace(',', ' ') }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card shadow-sm bg-success text-white">
            <div class="card-body">
                <h6 class="card-title"><i class="bi bi-activity"></i> Jobs Total</h6>
                <h3 class="mb-0">{{ "{:,}".format(stats.jobs_count).replace(',', ' ') }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card shadow-sm bg-warning text-dark">
            <div class="card-body">
                <h6 class="card-title"><i class="bi bi-clock-history"></i> Jobs > 6 mois</h6>
                <h3 class="mb-0">{{ "{:,}".format(stats.jobs_old_count).replace(',', ' ') }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card shadow-sm {% if stats.dedup_active %}bg-info{% else %}bg-secondary{% endif %} text-white">
            <div class="card-body">
                <h6 class="card-title"><i class="bi bi-layers"></i> Déduplication</h6>
                <h3 class="mb-0">{% if stats.dedup_active %}Activée{% else %}Désactivée{% endif %}</h3>
            </div>
        </div>
    </div>
</div>

<!-- Navigation rapide -->
<div class="row">
    <div class="col-lg-6 mb-4">
        <div class="card shadow-sm border-warning">
            <div class="card-header bg-warning">
                <h5 class="mb-0"><i class="bi bi-broom"></i> Nettoyage</h5>
            </div>
            <div class="card-body">
                <p class="text-muted">Supprimer les jobs anciens et gérer les doublons</p>
                <div class="d-grid gap-2">
                    <a href="{{ url_for('admin.maintenance_db_cleanup_old') }}" class="btn btn-warning">
                        <i class="bi bi-clock-history"></i> Nettoyer jobs > 6 mois ({{ "{:,}".format(stats.jobs_old_count).replace(',', ' ') }} jobs)
                    </a>
                    <a href="{{ url_for('admin.maintenance_db_deduplication') }}" class="btn btn-info text-white">
                        <i class="bi bi-layers"></i> Supprimer les doublons
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-6 mb-4">
        <div class="card shadow-sm border-danger">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0"><i class="bi bi-exclamation-triangle-fill"></i> DANGER ZONE</h5>
            </div>
            <div class="card-body">
                <p class="text-muted">Purges complètes <strong>IRRÉVERSIBLES</strong></p>
                <div class="d-grid gap-2">
                    <a href="{{ url_for('admin.maintenance_db_purge_cmdb') }}" class="btn btn-outline-danger">
                        <i class="bi bi-database-x"></i> Vidage CMDB ({{ "{:,}".format(stats.cmdb_count).replace(',', ' ') }} entrées)
                    </a>
                    <a href="{{ url_for('admin.maintenance_db_purge_jobs') }}" class="btn btn-outline-danger">
                        <i class="bi bi-activity"></i> Vidage Jobs ({{ "{:,}".format(stats.jobs_count).replace(',', ' ') }} jobs)
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Informations -->
<div class="card shadow-sm border-primary">
    <div class="card-header bg-primary text-white">
        <h6 class="mb-0"><i class="bi bi-info-circle"></i> Informations</h6>
    </div>
    <div class="card-body">
        <ul class="mb-0">
            <li><strong>Sauvegardes</strong> : Avant toute purge, créez une sauvegarde dans 
                <a href="{{ url_for('backup.index') }}">Sauvegarde & Restauration</a>
            </li>
            <li><strong>Logs</strong> : Toutes les opérations de maintenance sont tracées dans l'historique</li>
            <li><strong>Performance</strong> : Le nettoyage régulier des vieux jobs améliore les performances</li>
            <li><strong>Déduplication</strong> : Activez la déduplication automatique pour éviter les doublons lors des imports</li>
        </ul>
    </div>
</div>
{% endblock %}
